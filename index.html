<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>實踐旅遊 USC tours - 功能修復版</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            --main-red: #C01B21;
            --dark-gray: #333;
        }

        body {
            font-family: "Microsoft JhengHei", sans-serif;
            color: var(--dark-gray);
            background-color: #fff;
        }

        .navbar {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
            background: #fff;
            z-index: 1050 !important;
        }

        .navbar-brand {
            color: var(--main-red) !important;
            font-weight: bold;
            text-decoration: none;
        }

        .hero-banner {
            background: url('img/hero.jpg') center/cover;
            padding: 50px 0 80px 0;
            min-height: 400px;
        }

        .search-container {
            background: white;
            border-radius: 4px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.2);
            max-width: 800px;
            margin: 0 auto;
            overflow: hidden;
        }

        .nav-tabs-custom {
            display: flex;
            border-bottom: 2px solid #eee;
            background: #fff;
        }

            .nav-tabs-custom .nav-link {
                flex: 1;
                padding: 12px;
                text-align: center;
                border: none;
                background: none;
                color: #888;
                border-bottom: 3px solid transparent;
                cursor: pointer;
            }

                .nav-tabs-custom .nav-link.active {
                    color: var(--main-red);
                    border-bottom-color: var(--main-red);
                    font-weight: bold;
                }

        .section-title {
            border-left: 5px solid var(--main-red);
            padding-left: 15px;
            margin: 40px 0 25px 0;
            font-weight: bold;
        }

        .tour-card {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
            transition: 0.3s;
            background: #fff;
        }

        .price-text {
            color: var(--main-red);
            font-size: 1.3rem;
            font-weight: bold;
        }

        .footer-main {
            background-color: #444;
            color: #ddd;
            padding: 40px 0 20px 0;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>

    <nav class="navbar sticky-top shadow-sm">
        <div class="container d-flex justify-content-between align-items-center">
            <a class="navbar-brand" href="javascript:location.reload()">實踐旅遊 USC tours</a>
            <div class="d-flex align-items-center">
                <span id="user-display" class="me-3 small fw-bold text-secondary"></span>
                <button class="btn btn-sm btn-outline-danger me-2" id="login-nav-btn" data-bs-toggle="modal" data-bs-target="#loginModal">登入/註冊</button>
                <button class="btn btn-sm btn-dark me-2" id="logout-nav-btn" onclick="handleLogout()" style="display:none;">登出</button>
                <button class="btn btn-outline-dark" onclick="showTab('cart')">預選清單 (<span id="cart-badge">0</span>)</button>
            </div>
        </div>
    </nav>

    <section class="hero-banner">
        <div class="container">
            <div class="search-container">
                <div class="nav nav-tabs-custom">
                    <button class="nav-link active" id="tab-all-btn" onclick="showTab('all')">精選方案</button>
                    <button class="nav-link" id="tab-flight-btn" onclick="showTab('flight')">機票</button>
                    <button class="nav-link" id="tab-cruise-btn" onclick="showTab('cruise')">郵輪</button>
                    <button class="nav-link" id="tab-hotel-btn" onclick="showTab('hotel')">訂房</button>
                    <button class="nav-link" id="tab-cart-btn" onclick="showTab('cart')">我的清單</button>
                </div>
                <div class="p-4">
                    <div id="search-action-area">
                        <div class="input-group border rounded overflow-hidden">
                            <input type="text" id="keyword-input" class="form-control border-0" placeholder="搜尋目的地...">
                            <button class="btn btn-danger rounded-0" onclick="performSearch()">搜尋</button>
                        </div>
                    </div>
                    <div id="pane-cart-display" style="display:none;">
                        <div id="upper-cart-list"></div>
                        <div id="cart-total-price" class="p-3 text-end fw-bold text-danger fs-5"></div>
                        <div class="row g-2 mt-3">
                            <div class="col-6"><button class="btn btn-dark w-100 py-2">前往結帳</button></div>
                            <div class="col-6"><button class="btn btn-outline-success w-100 py-2" onclick="exportCartToCSV()">匯出 CSV</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <main class="container mb-5">
        <h3 class="section-title" id="grid-title">所有方案精選</h3>
        <div class="row g-4" id="main-items-grid"></div>
    </main>

    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0"><h5 class="modal-title fw-bold">會員登入</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-2"><label class="small text-muted">帳號</label><input type="text" id="login-user" class="form-control"></div>
                    <div class="mb-3"><label class="small text-muted">密碼</label><input type="password" id="login-pass" class="form-control"></div>
                    <button class="btn btn-danger w-100 mb-2" onclick="handleLogin()">登入</button>
                    <button class="btn btn-outline-secondary w-100" onclick="handleRegister()">註冊新帳號</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body p-0">
                    <div class="row g-0">
                        <div class="col-lg-7"><img id="m-image" src="" class="img-fluid w-100 h-100" style="object-fit:cover; min-height:450px;"></div>
                        <div class="col-lg-5 p-5"><h2 id="m-name" class="fw-bold"></h2><p id="m-text" class="text-muted"></p><h2 id="m-price-val" class="text-danger fw-bold"></h2><button id="m-buy-btn" class="btn btn-danger btn-lg w-100">加入清單</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script>
        const travelDB = [
            { id: 1, type: 'flight', name: "長榮航空 東京機票", desc: "成田/羽田自由搭配。", price: 15800, img: "img/tokyo.jpg" },
            { id: 2, type: 'flight', name: "中華航空 倫敦機票", desc: "直飛希斯洛。", price: 32500, img: "img/london.jpg" },
            { id: 3, type: 'cruise', name: "歌詩達郵輪 莎倫娜號", desc: "沖繩假期。", price: 17900, img: "img/costa.jpg" },
            { id: 4, type: 'cruise', name: "地中海郵輪 榮耀號", desc: "基隆港出發。", price: 21900, img: "img/msc.jpg" },
            { id: 8, type: 'hotel', name: "京都麗思卡爾頓", desc: "極致奢華。", price: 18500, img: "img/ritz-kyoto.jpg" },
            { id: 9, type: 'hotel', name: "星野集團 RISONARE 小濱島", desc: "享受私人沙灘。", price: 12800, img: "img/hoshino.jpg" }
        ];

        let cartData = [];
        let currentUser = sessionStorage.getItem('usc_login_user') || null;
        let usersDB = JSON.parse(localStorage.getItem('usc_users')) || {};

        window.onload = () => {
            if (currentUser && usersDB[currentUser]) {
                cartData = usersDB[currentUser].cart || [];
                updateUserUI();
            }
            renderItemsGrid('all');
            renderAllSynchronizedUI();
        };

        // --- 註冊與登入邏輯 ---
        function handleRegister() {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            if (!u || !p) return alert("請輸入帳號密碼");
            if (usersDB[u]) return alert("此帳號已存在");
            usersDB[u] = { password: p, cart: [] };
            localStorage.setItem('usc_users', JSON.stringify(usersDB));
            alert("註冊成功，請登入！");
        }

        function handleLogin() {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            if (usersDB[u] && usersDB[u].password === p) {
                currentUser = u;
                sessionStorage.setItem('usc_login_user', u);
                cartData = usersDB[u].cart || [];
                bootstrap.Modal.getOrCreateInstance(document.getElementById('loginModal')).hide();
                updateUserUI();
                renderAllSynchronizedUI();
            } else alert("登入失敗，請檢查帳號密碼");
        }

        function handleLogout() {
            currentUser = null;
            sessionStorage.removeItem('usc_login_user');
            cartData = [];
            updateUserUI();
            renderAllSynchronizedUI();
        }

        function updateUserUI() {
            document.getElementById('login-nav-btn').style.display = currentUser ? 'none' : 'inline-block';
            document.getElementById('logout-nav-btn').style.display = currentUser ? 'inline-block' : 'none';
            document.getElementById('user-display').innerText = currentUser ? `👋 ${currentUser}` : '';
        }

        // --- UI 渲染邏輯 ---
        function showTab(cat) {
            document.querySelectorAll('.nav-link').forEach(n => n.classList.toggle('active', n.id === `tab-${cat}-btn`));
            document.getElementById('search-action-area').style.display = cat === 'cart' ? 'none' : 'block';
            document.getElementById('pane-cart-display').style.display = cat === 'cart' ? 'block' : 'none';
            document.getElementById('grid-title').innerText = cat === 'cart' ? "您的預選清單" : "精選方案";
            cat === 'cart' ? renderAllSynchronizedUI() : renderItemsGrid(cat);
        }

        function renderItemsGrid(cat) {
            const data = cat === 'all' ? travelDB : travelDB.filter(i => i.type === cat);
            const grid = document.getElementById('main-items-grid');
            grid.innerHTML = data.map(i => `
                    <div class="col-md-4"><div class="tour-card">
                        <img src="${i.img}" class="w-100" style="height:200px;object-fit:cover;">
                        <div class="p-3"><h5>${i.name}</h5><div class="d-flex justify-content-between mt-3">
                            <span class="price-text">NT$ ${i.price.toLocaleString()}</span>
                            <button class="btn btn-outline-danger btn-sm" onclick="openDetail(${i.id})">詳情</button>
                        </div></div>
                    </div></div>`).join('');
        }

        function renderAllSynchronizedUI() {
            document.getElementById('cart-badge').innerText = cartData.length;
            const list = document.getElementById('upper-cart-list');
            list.innerHTML = cartData.length ? cartData.map(i => `
                    <div class="cart-item"><span>${i.name}</span><button class="btn btn-sm btn-link text-danger" onclick="removeFromCart(${i.cartId})">[刪除]</button></div>`).join('') : '<p class="p-4 text-center text-muted">清單內目前是空的</p>';

            const total = cartData.reduce((s, x) => s + x.price, 0);
            document.getElementById('cart-total-price').innerText = `總計：NT$ ${total.toLocaleString()}`;
            document.getElementById('cart-total-price').style.display = cartData.length ? 'block' : 'none';

            if (document.getElementById('tab-cart-btn').classList.contains('active')) {
                const grid = document.getElementById('main-items-grid');
                grid.innerHTML = cartData.length ? cartData.map(i => `
                        <div class="col-md-4"><div class="tour-card">
                            <img src="${i.img}" class="w-100" style="height:200px;object-fit:cover;">
                            <div class="p-3"><h5>${i.name}</h5><p class="price-text my-2">NT$ ${i.price.toLocaleString()}</p>
                            <button class="btn btn-dark w-100" onclick="removeFromCart(${i.cartId})">移除此行程</button></div>
                        </div></div>`).join('') : '<div class="col-12 text-center py-5 text-muted">清單內目前是空的</div>';
            }
        }

        function openDetail(id) {
            const i = travelDB.find(x => x.id === id);
            document.getElementById('m-image').src = i.img;
            document.getElementById('m-name').innerText = i.name;
            document.getElementById('m-text').innerText = i.desc;
            document.getElementById('m-price-val').innerText = `NT$ ${i.price.toLocaleString()}`;
            document.getElementById('m-buy-btn').onclick = () => {
                cartData.push({ ...i, cartId: Date.now() });
                if (currentUser) { usersDB[currentUser].cart = cartData; localStorage.setItem('usc_users', JSON.stringify(usersDB)); }
                renderAllSynchronizedUI();
                bootstrap.Modal.getInstance(document.getElementById('infoModal')).hide();
            };
            new bootstrap.Modal(document.getElementById('infoModal')).show();
        }

        function removeFromCart(id) {
            cartData = cartData.filter(x => x.cartId !== id);
            if (currentUser) { usersDB[currentUser].cart = cartData; localStorage.setItem('usc_users', JSON.stringify(usersDB)); }
            renderAllSynchronizedUI();
        }

        // --- 匯出 CSV 邏輯 ---
        function exportCartToCSV() {
            if (!cartData.length) return alert("清單內沒有行程可匯出");
            let csvContent = "\uFEFF帳號,行程名稱,價格\n";
            cartData.forEach(item => {
                csvContent += `${currentUser || '訪客'},${item.name},${item.price}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `USC_Travel_Plan_${currentUser || 'Guest'}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function performSearch() {
            const kw = document.getElementById('keyword-input').value.toLowerCase();
            const results = travelDB.filter(i => i.name.toLowerCase().includes(kw));
            const grid = document.getElementById('main-items-grid');
            document.getElementById('grid-title').innerText = `搜尋結果: "${kw}"`;
            grid.innerHTML = results.length ? results.map(i => `
                    <div class="col-md-4"><div class="tour-card"><img src="${i.img}" class="w-100" style="height:200px;object-fit:cover;"><div class="p-3"><h5>${i.name}</h5><div class="d-flex justify-content-between"><span class="price-text">NT$ ${i.price.toLocaleString()}</span><button class="btn btn-outline-danger btn-sm" onclick="openDetail(${i.id})">詳情</button></div></div></div></div>
                `).join('') : '<div class="col-12 text-center py-5">找不到符合的方案</div>';
        }
    </script>
</body>
</html>